<!--toc=cms_upgrade-->

# Dockerインストールのアップグレード

## アップグレードを行う前に
メディアファイルやデータベースファイルが、`共有`ディレクトリに正しく書き込まれていることを確認してください。これは、Windowsコンピュータで動作している場合、特に重要です。そのためには、例えば画像をCMSにアップロードし、同じ画像が`shared/cms/library`ディレクトリに表示されることを確認します。また、`shared/backup/db/latest.sql.gz`が過去24時間以内に作成されているかどうかも確認するとよいでしょう。これらのチェックのいずれかに失敗した場合、データの損失につながるため、アップグレードを続行しないでください。状況を回復するためにサポートを求めてください。

アップグレードを開始する前に、[[PRODUCTNAME]]システムの完全なバックアップを取ることを強くお勧めします。そこで、コマンドを発行してCMSを停止してください。

```
docker-compose stop
```

そして、`config.env`、`docker-compose`のファイル、共有ディレクトリをバックアップして、安全な場所に保管してください。Linuxシステムの場合、`root`ユーザーになるか、`sudo`を使用して共有ディレクトリのコピーを作成する必要があります。

CMS ファイルの適切なバックアップが取れたら、アップグレードのプロセスを進めることができます。

## アップグレードプロセス

- アップグレードしたい Xibo のバージョンに対応した [Docker Compose](https://github.com/xibosignage/xibo-docker/releases) ファイルをダウンロードします。
- Docker Compose ファイルを既存のインストールに重ねて展開し、既存のファイルを置き換えます。

CMS on Custom Ports を実行している場合は、CMS のインストールプロセスの最初のステップで、テンプレートの `cms_custom-ports.yml.template` ファイルを `cms_custom-ports.yml` にコピーし、使用したい ports に対して適切な修正を行うことを繰り返す必要があります。

`config.env` は保存されているので、特に変更する必要はありません。特に、このファイルのMySQLパスワードは変更しないでください。

アップグレードを行うには、以下を実行します。

```
docker-compose down
docker-compose up -d
```

を実行します。カスタムポートやリモートの MySQL サーバを使用している場合は、2 番目のコマンドを適切な up コマンドに置き換えてください。

CMSコンテナは破棄され、新しい[[PRODUCTNAME]]のバージョンで再構築されます。

このプロセスの一環として、データベースのバックアップが自動的に実行されます。

{tip}
**しばらくお待ちください。**アップグレードプロセスは数分かかることがあります。この間、CMSは利用できなくなります。アップグレードに成功すると、CMSにログインしたときにアップグレードウィザードが表示されなくなります。
アップグレードウィザードが表示された場合は、そのウィザードに従って作業を行うことができますが、安全であるという詳細な知識がない限り、アップグレードステップをスキップすることにはご注意ください。
{/tip}

これでアップグレードは完了です。

## バージョンアップのロールバック

何らかの理由で古い[[PRODUCTNAME]]のバージョンにロールバックする必要がある場合は、以下を実行することでロールバックすることができます。

```
docker-compose down
```

`config.env`、`Docker Compose`ファイル、`共有`ディレクトリを元に戻し、最後に以下を実行します。

```
docker-compose up -d
```

これで、CMSのオリジナルバージョンが復元されます。
